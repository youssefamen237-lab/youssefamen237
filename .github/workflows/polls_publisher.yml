name: üó≥Ô∏è Daily Community Polls Publisher

on:
  schedule:
    # Runs at 08:00 UTC daily (after daily_publish has already run)
    - cron: "0 8 * * *"
  workflow_dispatch:

concurrency:
  group: polls-publisher
  cancel-in-progress: false

jobs:
  polls:
    name: Post Community Polls (1‚Äì4 per day)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      GEMINI_API_KEY:   ${{ secrets.GEMINI_API_KEY }}
      GROQ_API_KEY:     ${{ secrets.GROQ_API_KEY }}
      OPENAI_API_KEY:   ${{ secrets.OPENAI_API_KEY }}
      OPENROUTER_KEY:   ${{ secrets.OPENROUTER_KEY }}
      YT_CHANNEL_ID:    ${{ secrets.YT_CHANNEL_ID }}
      YT_CLIENT_ID_2:   ${{ secrets.YT_CLIENT_ID_2 }}
      YT_CLIENT_SECRET_2: ${{ secrets.YT_CLIENT_SECRET_2 }}
      YT_REFRESH_TOKEN_2: ${{ secrets.YT_REFRESH_TOKEN_2 }}
      # Non-critical extras (passed in case PollsEngine expands)
      NEWS_API:         ${{ secrets.NEWS_API }}
      SERPAPI:          ${{ secrets.SERPAPI }}

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: üì¶ Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: üìÇ Restore data cache
        uses: actions/cache@v4
        with:
          path: |
            data/questions_db.json
            data/publish_log.json
            data/polls_log.json
            data/strategy_config.json
          key: quizzaro-data-${{ github.run_number }}
          restore-keys: |
            quizzaro-data-

      - name: üó≥Ô∏è Run polls engine
        run: python main.py --mode polls

      - name: üíæ Save data cache
        if: always()
        uses: actions/cache@v4
        with:
          path: |
            data/questions_db.json
            data/publish_log.json
            data/polls_log.json
            data/strategy_config.json
          key: quizzaro-data-${{ github.run_number }}
