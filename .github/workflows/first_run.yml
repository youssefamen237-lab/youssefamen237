name: First Run â€” Initial Launch

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "LAUNCH" to confirm first run'
        required: true

jobs:
  first-run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: ${{ github.event.inputs.confirm == 'LAUNCH' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg libsndfile1 fonts-dejavu-core fonts-liberation imagemagick
          ffmpeg -version

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-first-run

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install gtts

      - name: Initialize data directory
        run: |
          mkdir -p data assets/backgrounds assets/music assets/sfx assets/fonts

      - name: Produce and upload first Short
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENROUTER_KEY: ${{ secrets.OPENROUTER_KEY }}
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          FREESOUND_API: ${{ secrets.FREESOUND_API }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          YT_CLIENT_ID_1: ${{ secrets.YT_CLIENT_ID_1 }}
          YT_CLIENT_SECRET_1: ${{ secrets.YT_CLIENT_SECRET_1 }}
          YT_REFRESH_TOKEN_1: ${{ secrets.YT_REFRESH_TOKEN_1 }}
          YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          cd src
          python -c "
          from shorts_runner import produce_one_short
          from project_manager import get_current_strategy
          import json, os

          os.makedirs('../data', exist_ok=True)
          strategy = get_current_strategy()
          record = produce_one_short(1, strategy, [])

          with open('../data/videos_log.json', 'w') as f:
              json.dump([record], f, indent=2)

          print(f'FIRST SHORT LIVE: https://youtu.be/{record[\"video_id\"]}')
          "

      - name: Produce and upload first Long Video
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENROUTER_KEY: ${{ secrets.OPENROUTER_KEY }}
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          FREESOUND_API: ${{ secrets.FREESOUND_API }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          YT_CLIENT_ID_1: ${{ secrets.YT_CLIENT_ID_1 }}
          YT_CLIENT_SECRET_1: ${{ secrets.YT_CLIENT_SECRET_1 }}
          YT_REFRESH_TOKEN_1: ${{ secrets.YT_REFRESH_TOKEN_1 }}
          YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          cd src
          python long_runner.py

      - name: Save data directory
        uses: actions/cache@v4
        with:
          path: data/
          key: quiz-plus-data-1

      - name: Commit initial data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/ || true
          git diff --staged --quiet || git commit -m "feat: first run complete - channel live [skip ci]"
          git push || true
