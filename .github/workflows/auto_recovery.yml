name: ðŸ”„ Auto Recovery â€” Retry Failed Jobs

on:
  workflow_run:
    workflows:
      - "ðŸ“± Publish Daily Shorts"
      - "ðŸŽ¬ Publish Long Videos"
    types:
      - completed
  schedule:
    # Also check and retry every 6 hours in case something was missed
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  check-and-retry:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event.workflow_run.conclusion == 'failure' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Failed Runs and Retry
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get recent workflow runs
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo,
            });

            const targetWorkflows = ['publish_shorts.yml', 'publish_long.yml'];

            for (const wf of workflows.data.workflows) {
              const filename = wf.path.split('/').pop();
              if (!targetWorkflows.includes(filename)) continue;

              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: wf.id,
                per_page: 5,
              });

              for (const run of runs.data.workflow_runs) {
                // Only retry runs that failed in the last 12 hours
                const runDate = new Date(run.created_at);
                const now = new Date();
                const hoursAgo = (now - runDate) / (1000 * 60 * 60);

                if (hoursAgo < 12 && run.conclusion === 'failure') {
                  console.log(`Retrying failed run: ${run.name} #${run.run_number}`);
                  try {
                    await github.rest.actions.reRunWorkflow({
                      owner,
                      repo,
                      run_id: run.id,
                    });
                    console.log(`Rerun triggered for ${run.name}`);
                  } catch (e) {
                    console.log(`Could not rerun: ${e.message}`);
                  }
                  break; // Only retry the most recent failure
                }
              }
            }

      - name: Report
        run: |
          echo "Recovery check completed at $(date -u)"
