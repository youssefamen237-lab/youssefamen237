name: üéûÔ∏è Weekly Long Video Compilation

on:
  schedule:
    # Every Sunday at 06:00 UTC ‚Äî compiles the past week's best Shorts
    - cron: "0 6 * * 0"
  workflow_dispatch:

concurrency:
  group: long-compilation
  cancel-in-progress: false

jobs:
  compile:
    name: Build & Upload Weekly Compilation
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      GEMINI_API_KEY:     ${{ secrets.GEMINI_API_KEY }}
      GROQ_API_KEY:       ${{ secrets.GROQ_API_KEY }}
      OPENAI_API_KEY:     ${{ secrets.OPENAI_API_KEY }}
      OPENROUTER_KEY:     ${{ secrets.OPENROUTER_KEY }}
      YOUTUBE_API_KEY:    ${{ secrets.YOUTUBE_API_KEY }}
      YT_CHANNEL_ID:      ${{ secrets.YT_CHANNEL_ID }}
      YT_CLIENT_ID_1:     ${{ secrets.YT_CLIENT_ID_1 }}
      YT_CLIENT_SECRET_1: ${{ secrets.YT_CLIENT_SECRET_1 }}
      YT_REFRESH_TOKEN_1: ${{ secrets.YT_REFRESH_TOKEN_1 }}

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: üì¶ Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg fonts-dejavu-core

      - name: üì¶ Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: üìÇ Restore data cache
        uses: actions/cache@v4
        with:
          path: |
            data/publish_log.json
            data/quota_log.json
            data/strategy_config.json
          key: quizzaro-data-${{ github.run_number }}
          restore-keys: |
            quizzaro-data-

      - name: üéûÔ∏è Build and upload weekly compilation
        run: python main.py --mode compilation

      - name: üíæ Save updated publish log
        if: always()
        uses: actions/cache@v4
        with:
          path: |
            data/publish_log.json
            data/quota_log.json
          key: quizzaro-data-${{ github.run_number }}
