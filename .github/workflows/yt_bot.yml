name: ğŸš€â€¯YouTubeâ€¯Botâ€¯Automation

# ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠØŒ Ø£Ùˆ Ø¹Ù†Ø¯ ÙƒÙ„ Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ mainØŒ Ø£Ùˆ Ø¨Ø´ÙƒÙ„ Ù…Ø¬Ø¯ÙˆÙ„
on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"   # ÙƒÙ„ ÙŠÙˆÙ… ÙÙŠ 02:00â€¯UTC Ù„ØªÙˆÙ„ÙŠØ¯ Shorts Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
    - cron: "0 4 * * 1"   # ÙƒÙ„ Ø§Ø«Ù†ÙŠÙ† (ÙŠÙˆÙ… Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†) ÙÙŠ 04:00â€¯UTC Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write   # Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¯ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ GitHub Packages
      id-token: write

    steps:
      # ---------- Checkout ----------
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # ---------- Set up Python (Ù„Ø§ ÙŠÙØ³ØªÙØ®Ø¯Ù… Ø¥Ù„Ø§ Ù„Ù„Ù€â€¯dockerâ€‘build) ----------
      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------- Build Docker image ----------
      - name: ğŸ—ï¸ Build Docker image
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/yt-bot:latest .

      # ---------- Push image to GitHub Container Registry (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ----------
      - name: ğŸ“¦ Push image (optional)
        if: ${{ github.event_name != 'schedule' }}   # Ù„Ø§ ØªØ¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø¥Ø°Ø§ Ù„Ø§ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Registry
        env:
          CR_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo $CR_PAT | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
          docker push ghcr.io/${{ github.repository_owner }}/yt-bot:latest

      # ---------- Run container â€“ pass all secrets ----------
      - name: ğŸš€ Run container (daily short batch)
        env:
          # ---- ÙƒÙ„ Ù…ÙØªØ§Ø­ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€â€¯Secrets ----
          GEMINI_API_KEY:           ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY:             ${{ secrets.GROQ_API_KEY }}
          ELEVEN_API_KEY:           ${{ secrets.ELEVEN_API_KEY }}
          YT_CLIENT_ID_3:           ${{ secrets.YT_CLIENT_ID_3 }}
          YT_CLIENT_SECRET_3:       ${{ secrets.YT_CLIENT_SECRET_3 }}
          YT_REFRESH_TOKEN_3:       ${{ secrets.YT_REFRESH_TOKEN_3 }}
          YT_CHANNEL_ID:            ${{ secrets.YT_CHANNEL_ID }}
          # (Ø£ÙŠØ© Ù…ÙØ§ØªÙŠØ­ Ø£Ø®Ø±Ù‰ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù‡Ù†Ø§)
        run: |
          # ØªØ´ØºÙŠÙ„ Ø¯ÙØ¹Ø© Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ù€â€¯cron Ø§Ù„ÙŠÙˆÙ…ÙŠ) Ø£Ùˆ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¯Ø«
          if [[ "${{ github.event_name }}" == "schedule" && "${{ github.event.schedule }}" == "0 4 * * 1" ]]; then
              MODE=weekly
          else
              MODE=daily
          fi
          docker run --rm \
            -e GEMINI_API_KEY \
            -e GROQ_API_KEY \
            -e ELEVEN_API_KEY \
            -e YT_CLIENT_ID_3 \
            -e YT_CLIENT_SECRET_3 \
            -e YT_REFRESH_TOKEN_3 \
            -e YT_CHANNEL_ID \
            -v ${{ github.workspace }}/data:/app/data \
            ghcr.io/${{ github.repository_owner }}/yt-bot:latest \
            python -m scripts.run_batch $MODE

      # ---------- Show logs (last 200 lines) ----------
      - name: ğŸ“œ Show recent logs
        if: always()
        run: |
          ls -l data/logs
          tail -n 200 data/logs/app.log || true
